<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Analizador de Vulnerabilidades</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .code-test {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>üß™ Test del Analizador de Vulnerabilidades</h1>
    
    <div class="test-section">
        <h2>1. Test de Validaci√≥n de HTML</h2>
        <div id="html-validation-test"></div>
    </div>
    
    <div class="test-section">
        <h2>2. Test de Validaci√≥n de Preguntas</h2>
        <div id="question-validation-test"></div>
    </div>
    
    <div class="test-section">
        <h2>3. Test de Validaci√≥n de Respuestas</h2>
        <div id="answer-validation-test"></div>
    </div>
    
    <div class="test-section">
        <h2>4. Test de Escape de HTML</h2>
        <div id="html-escape-test"></div>
    </div>

    <!-- Load the modules -->
    <script src="js/interfaces.js"></script>
    <script src="js/code-renderer.js"></script>
    <script src="js/selection-manager.js"></script>
    <script src="js/feedback-system.js"></script>
    <script src="js/question-manager.js"></script>

    <script>
        // Test utilities
        function runTest(testName, testFunction) {
            try {
                const result = testFunction();
                return {
                    name: testName,
                    success: true,
                    result: result,
                    error: null
                };
            } catch (error) {
                return {
                    name: testName,
                    success: false,
                    result: null,
                    error: error.message
                };
            }
        }

        function displayTestResult(containerId, testResult) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${testResult.success ? 'success' : 'error'}`;
            
            if (testResult.success) {
                resultDiv.innerHTML = `
                    <strong>‚úÖ ${testResult.name}</strong><br>
                    Resultado: ${testResult.result}
                `;
            } else {
                resultDiv.innerHTML = `
                    <strong>‚ùå ${testResult.name}</strong><br>
                    Error: ${testResult.error}
                `;
            }
            
            container.appendChild(resultDiv);
        }

        // Test 1: HTML Validation
        const htmlValidationTest = runTest('Validaci√≥n de HTML', () => {
            const testHtml = '<script>alert("xss")</script><p>Hello & "world"</p>';
            const escaped = ValidationUtils.escapeHtml(testHtml);
            const expected = '&lt;script&gt;alert(&quot;xss&quot;)&lt;/script&gt;&lt;p&gt;Hello &amp; &quot;world&quot;&lt;/p&gt;';
            
            if (escaped === expected) {
                return 'HTML escapado correctamente';
            } else {
                throw new Error(`Esperado: ${expected}, Obtenido: ${escaped}`);
            }
        });
        displayTestResult('html-validation-test', htmlValidationTest);

        // Test 2: Question Validation
        const questionValidationTest = runTest('Validaci√≥n de Preguntas', () => {
            const validQuestion = {
                id: 1,
                title: "Test Question",
                language: "javascript",
                difficulty: "basic",
                category: "xss",
                code: "console.log('hello');\nalert('world');",
                vulnerableLines: [2],
                vulnerabilityType: "XSS",
                question: "Find the vulnerability",
                explanation: {
                    vulnerability: "Test vuln",
                    exploitation: "Test exploit",
                    mitigation: "Test mitigation"
                }
            };
            
            const isValid = ValidationUtils.validateQuestion(validQuestion);
            if (isValid) {
                return 'Pregunta v√°lida detectada correctamente';
            } else {
                throw new Error('Pregunta v√°lida marcada como inv√°lida');
            }
        });
        displayTestResult('question-validation-test', questionValidationTest);

        // Test 3: Answer Validation
        const answerValidationTest = runTest('Validaci√≥n de Respuestas', () => {
            // Create a temporary feedback system for testing
            const tempDiv = document.createElement('div');
            document.body.appendChild(tempDiv);
            const feedbackSystem = new FeedbackSystem(tempDiv);
            
            const selectedLines = [1, 2];
            const correctLines = [2, 3];
            const result = feedbackSystem.validateAnswer(selectedLines, correctLines);
            
            document.body.removeChild(tempDiv);
            
            if (result.type === 'partial' && result.stats.correct === 1) {
                return `Validaci√≥n correcta: ${result.type}, ${result.stats.correct} l√≠neas correctas`;
            } else {
                throw new Error(`Resultado inesperado: ${JSON.stringify(result)}`);
            }
        });
        displayTestResult('answer-validation-test', answerValidationTest);

        // Test 4: HTML Escape Test
        const htmlEscapeTest = runTest('Escape de HTML en CodeRenderer', () => {
            const tempDiv = document.createElement('div');
            tempDiv.id = 'test-code-container';
            document.body.appendChild(tempDiv);
            
            const codeRenderer = new CodeRenderer('test-code-container');
            const maliciousCode = '<script>alert("xss")</script>\nconst x = "test";';
            const escaped = codeRenderer.escapeHtml(maliciousCode);
            
            document.body.removeChild(tempDiv);
            
            if (escaped.includes('&lt;script&gt;') && escaped.includes('&quot;test&quot;')) {
                return 'HTML escapado correctamente en CodeRenderer';
            } else {
                throw new Error(`Escape incorrecto: ${escaped}`);
            }
        });
        displayTestResult('html-escape-test', htmlEscapeTest);

        // Test 5: Array utilities
        const arrayUtilsTest = runTest('Utilidades de Arrays', () => {
            const arr1 = [1, 2, 3];
            const arr2 = [2, 3, 4];
            
            const intersection = ValidationUtils.arrayIntersection(arr1, arr2);
            const difference = ValidationUtils.arrayDifference(arr1, arr2);
            const equal = ValidationUtils.arraysEqual([1, 2], [2, 1]);
            
            if (intersection.length === 2 && difference.length === 1 && equal) {
                return 'Utilidades de arrays funcionando correctamente';
            } else {
                throw new Error(`Resultados incorrectos: intersecci√≥n=${intersection}, diferencia=${difference}, iguales=${equal}`);
            }
        });
        displayTestResult('html-escape-test', arrayUtilsTest);

        console.log('üß™ Tests completados');
    </script>
</body>
</html>